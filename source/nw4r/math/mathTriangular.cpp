#include "mathTriangular.hpp"

#include "mathCast.hpp"

namespace nw4r {
namespace math {

namespace detail {

// PAL: 0x80248010
const SinCosSample gSinCosTbl[256 + 1] = {
    0.f,        1.f,        0.024541f,  -0.000301f, 0.024541f,  0.999699f,
    0.024526f,  -0.000903f, 0.049068f,  0.998795f,  0.024497f,  -0.001505f,
    0.073565f,  0.99729f,   0.024453f,  -0.002106f, 0.098017f,  0.995185f,
    0.024394f,  -0.002705f, 0.122411f,  0.99248f,   0.02432f,   -0.003303f,
    0.14673f,   0.989177f,  0.024231f,  -0.003899f, 0.170962f,  0.985278f,
    0.024128f,  -0.004492f, 0.19509f,   0.980785f,  0.024011f,  -0.005083f,
    0.219101f,  0.975702f,  0.023879f,  -0.005671f, 0.24298f,   0.970031f,
    0.023733f,  -0.006255f, 0.266713f,  0.963776f,  0.023572f,  -0.006836f,
    0.290285f,  0.95694f,   0.023397f,  -0.007412f, 0.313682f,  0.949528f,
    0.023208f,  -0.007984f, 0.33689f,   0.941544f,  0.023005f,  -0.008551f,
    0.359895f,  0.932993f,  0.022788f,  -0.009113f, 0.382683f,  0.92388f,
    0.022558f,  -0.00967f,  0.405241f,  0.91421f,   0.022314f,  -0.01022f,
    0.427555f,  0.903989f,  0.022056f,  -0.010765f, 0.449611f,  0.893224f,
    0.021785f,  -0.011303f, 0.471397f,  0.881921f,  0.021501f,  -0.011834f,
    0.492898f,  0.870087f,  0.021205f,  -0.012358f, 0.514103f,  0.857729f,
    0.020895f,  -0.012875f, 0.534998f,  0.844854f,  0.020573f,  -0.013384f,
    0.55557f,   0.83147f,   0.020238f,  -0.013885f, 0.575808f,  0.817585f,
    0.019891f,  -0.014377f, 0.595699f,  0.803208f,  0.019532f,  -0.014861f,
    0.615232f,  0.788346f,  0.019162f,  -0.015336f, 0.634393f,  0.77301f,
    0.01878f,   -0.015802f, 0.653173f,  0.757209f,  0.018386f,  -0.016258f,
    0.671559f,  0.740951f,  0.017982f,  -0.016704f, 0.689541f,  0.724247f,
    0.017566f,  -0.01714f,  0.707107f,  0.707107f,  0.01714f,   -0.017566f,
    0.724247f,  0.689541f,  0.016704f,  -0.017982f, 0.740951f,  0.671559f,
    0.016258f,  -0.018386f, 0.757209f,  0.653173f,  0.015802f,  -0.01878f,
    0.77301f,   0.634393f,  0.015336f,  -0.019162f, 0.788346f,  0.615232f,
    0.014861f,  -0.019532f, 0.803208f,  0.595699f,  0.014377f,  -0.019891f,
    0.817585f,  0.575808f,  0.013885f,  -0.020238f, 0.83147f,   0.55557f,
    0.013384f,  -0.020573f, 0.844854f,  0.534998f,  0.012875f,  -0.020895f,
    0.857729f,  0.514103f,  0.012358f,  -0.021205f, 0.870087f,  0.492898f,
    0.011834f,  -0.021501f, 0.881921f,  0.471397f,  0.011303f,  -0.021785f,
    0.893224f,  0.449611f,  0.010765f,  -0.022056f, 0.903989f,  0.427555f,
    0.01022f,   -0.022314f, 0.91421f,   0.405241f,  0.00967f,   -0.022558f,
    0.92388f,   0.382683f,  0.009113f,  -0.022788f, 0.932993f,  0.359895f,
    0.008551f,  -0.023005f, 0.941544f,  0.33689f,   0.007984f,  -0.023208f,
    0.949528f,  0.313682f,  0.007412f,  -0.023397f, 0.95694f,   0.290285f,
    0.006836f,  -0.023572f, 0.963776f,  0.266713f,  0.006255f,  -0.023733f,
    0.970031f,  0.24298f,   0.005671f,  -0.023879f, 0.975702f,  0.219101f,
    0.005083f,  -0.024011f, 0.980785f,  0.19509f,   0.004492f,  -0.024128f,
    0.985278f,  0.170962f,  0.003899f,  -0.024231f, 0.989177f,  0.14673f,
    0.003303f,  -0.02432f,  0.99248f,   0.122411f,  0.002705f,  -0.024394f,
    0.995185f,  0.098017f,  0.002106f,  -0.024453f, 0.99729f,   0.073565f,
    0.001505f,  -0.024497f, 0.998795f,  0.049068f,  0.000903f,  -0.024526f,
    0.999699f,  0.024541f,  0.000301f,  -0.024541f, 1.f,        0.f,
    -0.000301f, -0.024541f, 0.999699f,  -0.024541f, -0.000903f, -0.024526f,
    0.998795f,  -0.049068f, -0.001505f, -0.024497f, 0.99729f,   -0.073565f,
    -0.002106f, -0.024453f, 0.995185f,  -0.098017f, -0.002705f, -0.024394f,
    0.99248f,   -0.122411f, -0.003303f, -0.02432f,  0.989177f,  -0.14673f,
    -0.003899f, -0.024231f, 0.985278f,  -0.170962f, -0.004492f, -0.024128f,
    0.980785f,  -0.19509f,  -0.005083f, -0.024011f, 0.975702f,  -0.219101f,
    -0.005671f, -0.023879f, 0.970031f,  -0.24298f,  -0.006255f, -0.023733f,
    0.963776f,  -0.266713f, -0.006836f, -0.023572f, 0.95694f,   -0.290285f,
    -0.007412f, -0.023397f, 0.949528f,  -0.313682f, -0.007984f, -0.023208f,
    0.941544f,  -0.33689f,  -0.008551f, -0.023005f, 0.932993f,  -0.359895f,
    -0.009113f, -0.022788f, 0.92388f,   -0.382683f, -0.00967f,  -0.022558f,
    0.91421f,   -0.405241f, -0.01022f,  -0.022314f, 0.903989f,  -0.427555f,
    -0.010765f, -0.022056f, 0.893224f,  -0.449611f, -0.011303f, -0.021785f,
    0.881921f,  -0.471397f, -0.011834f, -0.021501f, 0.870087f,  -0.492898f,
    -0.012358f, -0.021205f, 0.857729f,  -0.514103f, -0.012875f, -0.020895f,
    0.844854f,  -0.534998f, -0.013384f, -0.020573f, 0.83147f,   -0.55557f,
    -0.013885f, -0.020238f, 0.817585f,  -0.575808f, -0.014377f, -0.019891f,
    0.803208f,  -0.595699f, -0.014861f, -0.019532f, 0.788346f,  -0.615232f,
    -0.015336f, -0.019162f, 0.77301f,   -0.634393f, -0.015802f, -0.01878f,
    0.757209f,  -0.653173f, -0.016258f, -0.018386f, 0.740951f,  -0.671559f,
    -0.016704f, -0.017982f, 0.724247f,  -0.689541f, -0.01714f,  -0.017566f,
    0.707107f,  -0.707107f, -0.017566f, -0.01714f,  0.689541f,  -0.724247f,
    -0.017982f, -0.016704f, 0.671559f,  -0.740951f, -0.018386f, -0.016258f,
    0.653173f,  -0.757209f, -0.01878f,  -0.015802f, 0.634393f,  -0.77301f,
    -0.019162f, -0.015336f, 0.615232f,  -0.788346f, -0.019532f, -0.014861f,
    0.595699f,  -0.803208f, -0.019891f, -0.014377f, 0.575808f,  -0.817585f,
    -0.020238f, -0.013885f, 0.55557f,   -0.83147f,  -0.020573f, -0.013384f,
    0.534998f,  -0.844854f, -0.020895f, -0.012875f, 0.514103f,  -0.857729f,
    -0.021205f, -0.012358f, 0.492898f,  -0.870087f, -0.021501f, -0.011834f,
    0.471397f,  -0.881921f, -0.021785f, -0.011303f, 0.449611f,  -0.893224f,
    -0.022056f, -0.010765f, 0.427555f,  -0.903989f, -0.022314f, -0.01022f,
    0.405241f,  -0.91421f,  -0.022558f, -0.00967f,  0.382683f,  -0.92388f,
    -0.022788f, -0.009113f, 0.359895f,  -0.932993f, -0.023005f, -0.008551f,
    0.33689f,   -0.941544f, -0.023208f, -0.007984f, 0.313682f,  -0.949528f,
    -0.023397f, -0.007412f, 0.290285f,  -0.95694f,  -0.023572f, -0.006836f,
    0.266713f,  -0.963776f, -0.023733f, -0.006255f, 0.24298f,   -0.970031f,
    -0.023879f, -0.005671f, 0.219101f,  -0.975702f, -0.024011f, -0.005083f,
    0.19509f,   -0.980785f, -0.024128f, -0.004492f, 0.170962f,  -0.985278f,
    -0.024231f, -0.003899f, 0.14673f,   -0.989177f, -0.02432f,  -0.003303f,
    0.122411f,  -0.99248f,  -0.024394f, -0.002705f, 0.098017f,  -0.995185f,
    -0.024453f, -0.002106f, 0.073565f,  -0.99729f,  -0.024497f, -0.001505f,
    0.049068f,  -0.998795f, -0.024526f, -0.000903f, 0.024541f,  -0.999699f,
    -0.024541f, -0.000301f, 0.f,        -1.f,       -0.024541f, 0.000301f,
    -0.024541f, -0.999699f, -0.024526f, 0.000903f,  -0.049068f, -0.998795f,
    -0.024497f, 0.001505f,  -0.073565f, -0.99729f,  -0.024453f, 0.002106f,
    -0.098017f, -0.995185f, -0.024394f, 0.002705f,  -0.122411f, -0.99248f,
    -0.02432f,  0.003303f,  -0.14673f,  -0.989177f, -0.024231f, 0.003899f,
    -0.170962f, -0.985278f, -0.024128f, 0.004492f,  -0.19509f,  -0.980785f,
    -0.024011f, 0.005083f,  -0.219101f, -0.975702f, -0.023879f, 0.005671f,
    -0.24298f,  -0.970031f, -0.023733f, 0.006255f,  -0.266713f, -0.963776f,
    -0.023572f, 0.006836f,  -0.290285f, -0.95694f,  -0.023397f, 0.007412f,
    -0.313682f, -0.949528f, -0.023208f, 0.007984f,  -0.33689f,  -0.941544f,
    -0.023005f, 0.008551f,  -0.359895f, -0.932993f, -0.022788f, 0.009113f,
    -0.382683f, -0.92388f,  -0.022558f, 0.00967f,   -0.405241f, -0.91421f,
    -0.022314f, 0.01022f,   -0.427555f, -0.903989f, -0.022056f, 0.010765f,
    -0.449611f, -0.893224f, -0.021785f, 0.011303f,  -0.471397f, -0.881921f,
    -0.021501f, 0.011834f,  -0.492898f, -0.870087f, -0.021205f, 0.012358f,
    -0.514103f, -0.857729f, -0.020895f, 0.012875f,  -0.534998f, -0.844854f,
    -0.020573f, 0.013384f,  -0.55557f,  -0.83147f,  -0.020238f, 0.013885f,
    -0.575808f, -0.817585f, -0.019891f, 0.014377f,  -0.595699f, -0.803208f,
    -0.019532f, 0.014861f,  -0.615232f, -0.788346f, -0.019162f, 0.015336f,
    -0.634393f, -0.77301f,  -0.01878f,  0.015802f,  -0.653173f, -0.757209f,
    -0.018386f, 0.016258f,  -0.671559f, -0.740951f, -0.017982f, 0.016704f,
    -0.689541f, -0.724247f, -0.017566f, 0.01714f,   -0.707107f, -0.707107f,
    -0.01714f,  0.017566f,  -0.724247f, -0.689541f, -0.016704f, 0.017982f,
    -0.740951f, -0.671559f, -0.016258f, 0.018386f,  -0.757209f, -0.653173f,
    -0.015802f, 0.01878f,   -0.77301f,  -0.634393f, -0.015336f, 0.019162f,
    -0.788346f, -0.615232f, -0.014861f, 0.019532f,  -0.803208f, -0.595699f,
    -0.014377f, 0.019891f,  -0.817585f, -0.575808f, -0.013885f, 0.020238f,
    -0.83147f,  -0.55557f,  -0.013384f, 0.020573f,  -0.844854f, -0.534998f,
    -0.012875f, 0.020895f,  -0.857729f, -0.514103f, -0.012358f, 0.021205f,
    -0.870087f, -0.492898f, -0.011834f, 0.021501f,  -0.881921f, -0.471397f,
    -0.011303f, 0.021785f,  -0.893224f, -0.449611f, -0.010765f, 0.022056f,
    -0.903989f, -0.427555f, -0.01022f,  0.022314f,  -0.91421f,  -0.405241f,
    -0.00967f,  0.022558f,  -0.92388f,  -0.382683f, -0.009113f, 0.022788f,
    -0.932993f, -0.359895f, -0.008551f, 0.023005f,  -0.941544f, -0.33689f,
    -0.007984f, 0.023208f,  -0.949528f, -0.313682f, -0.007412f, 0.023397f,
    -0.95694f,  -0.290285f, -0.006836f, 0.023572f,  -0.963776f, -0.266713f,
    -0.006255f, 0.023733f,  -0.970031f, -0.24298f,  -0.005671f, 0.023879f,
    -0.975702f, -0.219101f, -0.005083f, 0.024011f,  -0.980785f, -0.19509f,
    -0.004492f, 0.024128f,  -0.985278f, -0.170962f, -0.003899f, 0.024231f,
    -0.989177f, -0.14673f,  -0.003303f, 0.02432f,   -0.99248f,  -0.122411f,
    -0.002705f, 0.024394f,  -0.995185f, -0.098017f, -0.002106f, 0.024453f,
    -0.99729f,  -0.073565f, -0.001505f, 0.024497f,  -0.998795f, -0.049068f,
    -0.000903f, 0.024526f,  -0.999699f, -0.024541f, -0.000301f, 0.024541f,
    -1.f,       -0.f,       0.000301f,  0.024541f,  -0.999699f, 0.024541f,
    0.000903f,  0.024526f,  -0.998795f, 0.049068f,  0.001505f,  0.024497f,
    -0.99729f,  0.073565f,  0.002106f,  0.024453f,  -0.995185f, 0.098017f,
    0.002705f,  0.024394f,  -0.99248f,  0.122411f,  0.003303f,  0.02432f,
    -0.989177f, 0.14673f,   0.003899f,  0.024231f,  -0.985278f, 0.170962f,
    0.004492f,  0.024128f,  -0.980785f, 0.19509f,   0.005083f,  0.024011f,
    -0.975702f, 0.219101f,  0.005671f,  0.023879f,  -0.970031f, 0.24298f,
    0.006255f,  0.023733f,  -0.963776f, 0.266713f,  0.006836f,  0.023572f,
    -0.95694f,  0.290285f,  0.007412f,  0.023397f,  -0.949528f, 0.313682f,
    0.007984f,  0.023208f,  -0.941544f, 0.33689f,   0.008551f,  0.023005f,
    -0.932993f, 0.359895f,  0.009113f,  0.022788f,  -0.92388f,  0.382683f,
    0.00967f,   0.022558f,  -0.91421f,  0.405241f,  0.01022f,   0.022314f,
    -0.903989f, 0.427555f,  0.010765f,  0.022056f,  -0.893224f, 0.449611f,
    0.011303f,  0.021785f,  -0.881921f, 0.471397f,  0.011834f,  0.021501f,
    -0.870087f, 0.492898f,  0.012358f,  0.021205f,  -0.857729f, 0.514103f,
    0.012875f,  0.020895f,  -0.844854f, 0.534998f,  0.013384f,  0.020573f,
    -0.83147f,  0.55557f,   0.013885f,  0.020238f,  -0.817585f, 0.575808f,
    0.014377f,  0.019891f,  -0.803208f, 0.595699f,  0.014861f,  0.019532f,
    -0.788346f, 0.615232f,  0.015336f,  0.019162f,  -0.77301f,  0.634393f,
    0.015802f,  0.01878f,   -0.757209f, 0.653173f,  0.016258f,  0.018386f,
    -0.740951f, 0.671559f,  0.016704f,  0.017982f,  -0.724247f, 0.689541f,
    0.01714f,   0.017566f,  -0.707107f, 0.707107f,  0.017566f,  0.01714f,
    -0.689541f, 0.724247f,  0.017982f,  0.016704f,  -0.671559f, 0.740951f,
    0.018386f,  0.016258f,  -0.653173f, 0.757209f,  0.01878f,   0.015802f,
    -0.634393f, 0.77301f,   0.019162f,  0.015336f,  -0.615232f, 0.788346f,
    0.019532f,  0.014861f,  -0.595699f, 0.803208f,  0.019891f,  0.014377f,
    -0.575808f, 0.817585f,  0.020238f,  0.013885f,  -0.55557f,  0.83147f,
    0.020573f,  0.013384f,  -0.534998f, 0.844854f,  0.020895f,  0.012875f,
    -0.514103f, 0.857729f,  0.021205f,  0.012358f,  -0.492898f, 0.870087f,
    0.021501f,  0.011834f,  -0.471397f, 0.881921f,  0.021785f,  0.011303f,
    -0.449611f, 0.893224f,  0.022056f,  0.010765f,  -0.427555f, 0.903989f,
    0.022314f,  0.01022f,   -0.405241f, 0.91421f,   0.022558f,  0.00967f,
    -0.382683f, 0.92388f,   0.022788f,  0.009113f,  -0.359895f, 0.932993f,
    0.023005f,  0.008551f,  -0.33689f,  0.941544f,  0.023208f,  0.007984f,
    -0.313682f, 0.949528f,  0.023397f,  0.007412f,  -0.290285f, 0.95694f,
    0.023572f,  0.006836f,  -0.266713f, 0.963776f,  0.023733f,  0.006255f,
    -0.24298f,  0.970031f,  0.023879f,  0.005671f,  -0.219101f, 0.975702f,
    0.024011f,  0.005083f,  -0.19509f,  0.980785f,  0.024128f,  0.004492f,
    -0.170962f, 0.985278f,  0.024231f,  0.003899f,  -0.14673f,  0.989177f,
    0.02432f,   0.003303f,  -0.122411f, 0.99248f,   0.024394f,  0.002705f,
    -0.098017f, 0.995185f,  0.024453f,  0.002106f,  -0.073565f, 0.99729f,
    0.024497f,  0.001505f,  -0.049068f, 0.998795f,  0.024526f,  0.000903f,
    -0.024541f, 0.999699f,  0.024541f,  0.000301f,  -0.f,       1.f,
    0.024541f,  -0.000301f,
};

} // namespace detail

namespace {
// PAL: 0x80274148
struct {
  f32 atan_val;
  f32 atan_delta;
} sArcTanTbl[32 + 1] = {
    0.000000000f,  1.272825321f,  1.272825321f,  1.270345790f,  2.543171111f,
    1.265415586f,  3.808586697f,  1.258091595f,  5.066678293f,  1.248457103f,
    6.315135396f,  1.236619467f,  7.551754863f,  1.222707202f,  8.774462065f,
    1.206866624f,  9.981328688f,  1.189258212f,  11.170586901f, 1.170052841f,
    12.340639741f, 1.149428034f,  13.490067775f, 1.127564381f,  14.617632156f,
    1.104642222f,  15.722274378f, 1.080838675f,  16.803113053f, 1.056325088f,
    17.859438141f, 1.031264918f,  18.890703059f, 1.005812061f,  19.896515121f,
    0.980109621f,  20.876624742f, 0.954289072f,  21.830913814f, 0.928469801f,
    22.759383615f, 0.902758952f,  23.662142567f, 0.877251558f,  24.539394125f,
    0.852030871f,  25.391424996f, 0.827168886f,  26.218593881f, 0.802726967f,
    27.021320848f, 0.778756582f,  27.800077430f, 0.755300081f,  28.555377511f,
    0.732391496f,  29.287769007f, 0.710057351f,  29.997826358f, 0.688317453f,
    30.686143811f, 0.667185647f,  31.353329458f, 0.646670542f,  32.000000000f,
    0.626776175f,
};

f32 AtanFIdx_(f32 x) {
  u16 idx;
  f32 val;
  f32 r;

  x *= 32.f;
  idx = f32_to_u16(x);
  r = x - u16_to_f32(idx);

  val = sArcTanTbl[idx].atan_val + r * sArcTanTbl[idx].atan_delta;

  return val;
}
} // namespace

f32 SinFIdx(f32 fidx) {
  f32 abs_fidx;
  f32 val;
  f32 r;
  u16 idx;

  abs_fidx = FAbs(fidx);
  while (abs_fidx > 65536.0f) {
    abs_fidx -= 65536.0f;
  }

  idx = f32_to_u16(abs_fidx);
  r = abs_fidx - u16_to_f32(idx);
  idx &= 0xff;

  val = detail::gSinCosTbl[idx].sin_val + r * detail::gSinCosTbl[idx].sin_delta;

  return (fidx < 0.0f) ? -val : val;
}

f32 CosFIdx(f32 fidx) {
  u16 idx;
  f32 r;

  fidx = FAbs(fidx);
  while (fidx > 65536.0f) {
    fidx -= 65536.0f;
  }

  idx = f32_to_u16(fidx);
  r = fidx - u16_to_f32(idx);
  idx &= 0xff;

  return detail::gSinCosTbl[idx].cos_val +
         r * detail::gSinCosTbl[idx].cos_delta;
}

void SinCosFIdx(register f32* pSin, register f32* pCos, register f32 fidx) {
  register u32 idx;
  register f32 abs_fidx;
  register f32 r;
  register f32 idxmax = 65536.0F;
  register __vec2x32float__ scval, scdel;
  register __vec2x32float__ result;

  register f32 c_zero;

  const register f32* pTbl =
      reinterpret_cast<const f32*>(&detail::gSinCosTbl[0]);

  asm {
    fabs abs_fidx, fidx;
    psq_st abs_fidx, 0(pSin), 1, 3;
    fcmpu cr0, abs_fidx, idxmax;
    ble loc2;
loc1:
    fsubs abs_fidx, abs_fidx, idxmax;
    fcmpu cr0, abs_fidx, idxmax;
    bgt loc1;
    psq_st abs_fidx, 0(pSin), 1, 3;
loc2:
    lhz idx, 0(pSin);
    fsubs c_zero, idxmax, idxmax;
    rlwinm idx, idx, 4, 20, 27;
    add pTbl, pTbl, idx;
    psq_l r, 0(pSin), 1, 3;
    fsubs r, abs_fidx, r;
    psq_l scval, 0(pTbl), 0, 0;
    psq_l scdel, 8(pTbl), 0, 0;
    ps_madds0 result, scdel, r, scval;
    ps_merge10 r, result, result;
    psq_st r, 0(pCos), 1, 0;
    fcmpu cr0, fidx, c_zero;
    bge loc3;
    ps_neg result, result;
loc3:
    psq_st result, 0(pSin), 1, 0;
  }
}

f32 AtanFIdx(f32 x) {
  if (x >= 0.f) {
    if (x > 1.f)
      return 64.f - AtanFIdx_(1.f / x);
    else
      return AtanFIdx_(x);
  } else {
    if (x < -1.f)
      return -64.f + AtanFIdx_(-1.f / x);
    else
      return -AtanFIdx_(-x);
  }
}

// PAL: 0x800853c0
f32 Atan2FIdx(f32 y, f32 x) {
  f32 a;
  f32 b;
  f32 c;
  bool minus;

  if (x == 0.f && y == 0.f) {
    return 0.f;
  }

  if (x >= 0.f) {
    if (y >= 0.f) {
      if (x >= y) {
        a = x;
        b = y;
        c = 0.f;
        minus = false;
      } else {
        a = y;
        b = x;
        c = 64.f;
        minus = true;
      }
    } else {
      if (x >= -y) {
        a = x;
        b = -y;
        c = 0.f;
        minus = true;
      } else {
        a = -y;
        b = x;
        c = -64.f;
        minus = false;
      }
    }
  } else {
    if (y >= 0.f) {
      if (-x >= y) {
        a = -x;
        b = y;
        c = 128.f;
        minus = true;
      } else {
        a = y;
        b = -x;
        c = 64.f;
        minus = false;
      }
    } else {
      if (-x >= -y) {
        a = -x;
        b = -y;
        c = -128.f;
        minus = false;
      } else {
        a = -y;
        b = -x;
        c = -64.f;
        minus = true;
      }
    }
  }

  return minus ? c - AtanFIdx_(b / a) : c + AtanFIdx_(b / a);
}

} // namespace math
} // namespace nw4r
