#include "l2c_main.h"

#include <string.h>

#include "gki_buffer.h"
#include "bte_logmsg.h"
#include "bte_task1.h"
#include "btm_sec.h"
#include "l2c_csm.h"
#include "l2c_link.h"
#include "l2c_utils.h"

// Symbol: l2c_init
// PAL: 0x8014d294..0x8014d3a8
MARK_BINARY_BLOB(l2c_init, 0x8014d294, 0x8014d3a8);
asm UNKNOWN_FUNCTION(l2c_init) {
  // clang-format off
  nofralloc;
  stwu r1, -0x10(r1);
  mflr r0;
  li r4, 0;
  li r5, 0x7e8;
  stw r0, 0x14(r1);
  stw r31, 0xc(r1);
  lis r31, 0x8034;
  addi r3, r31, -27840;
  bl memset;
  li r4, 1;
  li r0, 2;
  mulli r3, r4, 0x7c;
  addi r11, r31, -27840;
  li r7, 3;
  li r4, 4;
  add r8, r11, r3;
  addi r5, r11, 0x178;
  mulli r6, r7, 0x7c;
  li r7, 6;
  addi r10, r8, 0x178;
  stw r10, 0x180(r11);
  mulli r9, r0, 0x7c;
  li r0, 5;
  add r6, r11, r6;
  add r8, r11, r9;
  addi r6, r6, 0x178;
  mulli r3, r4, 0x7c;
  li r4, 7;
  addi r8, r8, 0x178;
  stw r8, 0x1fc(r11);
  add r8, r11, r3;
  mulli r9, r0, 0x7c;
  stw r6, 0x278(r11);
  addi r10, r8, 0x178;
  stw r10, 0x2f4(r11);
  li r0, 8;
  mulli r6, r7, 0x7c;
  add r8, r11, r9;
  li r7, 9;
  addi r8, r8, 0x178;
  mulli r3, r4, 0x7c;
  add r6, r11, r6;
  stw r8, 0x370(r11);
  addi r4, r11, 0x5d4;
  addi r6, r6, 0x178;
  add r8, r11, r3;
  mulli r9, r0, 0x7c;
  stw r6, 0x3ec(r11);
  addi r10, r8, 0x178;
  stw r10, 0x468(r11);
  li r3, 0;
  mulli r6, r7, 0x7c;
  add r8, r11, r9;
  li r0, 2;
  addi r8, r8, 0x178;
  add r6, r11, r6;
  stw r8, 0x4e4(r11);
  addi r6, r6, 0x178;
  stw r6, 0x560(r11);
  stw r5, 0x7b0(r11);
  stw r4, 0x7b4(r11);
  stb r3, 1(r11);
  sth r0, 0x7ba(r11);
  stb r3, -0x6cc0(r31);
  lwz r31, 0xc(r1);
  lwz r0, 0x14(r1);
  mtlr r0;
  addi r1, r1, 0x10;
  blr;
  // clang-format on
}

// Symbol: l2c_rcv_acl_data
// PAL: 0x8014d3a8..0x8014d6d8
MARK_BINARY_BLOB(l2c_rcv_acl_data, 0x8014d3a8, 0x8014d6d8);
asm UNKNOWN_FUNCTION(l2c_rcv_acl_data) {
  // clang-format off
  nofralloc;
  stwu r1, -0x30(r1);
  mflr r0;
  stw r0, 0x34(r1);
  addi r11, r1, 0x30;
  bl _savegpr_24;
  lhz r0, 4(r3);
  lis r30, 0x8028;
  mr r27, r3;
  li r28, 0;
  add r31, r3, r0;
  addi r30, r30, 0x66d8;
  lbz r0, 9(r31);
  lbz r3, 8(r31);
  slwi r0, r0, 8;
  add r0, r3, r0;
  rlwinm r5, r0, 0x14, 0x1e, 0x1f;
  cmplwi r5, 2;
  clrlwi r26, r0, 0x14;
  beq lbl_8014d420;
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014d414;
  lis r3, 8;
  addi r4, r30, 0;
  addi r3, r3, 1;
  bl LogMsg_1;
lbl_8014d414:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d420:
  mr r3, r26;
  bl l2cu_find_lcb_by_handle;
  cmpwi r3, 0;
  mr r29, r3;
  bne lbl_8014d500;
  lbz r3, 0xf(r31);
  lhz r0, 6(r27);
  lbz r4, 0xe(r31);
  slwi r3, r3, 8;
  cmpwi r0, 0;
  lbz r28, 0x10(r31);
  add r0, r4, r3;
  clrlwi r24, r0, 0x10;
  bne lbl_8014d4f4;
  cmplwi r24, 1;
  bne lbl_8014d4f4;
  cmplwi r28, 0xa;
  beq lbl_8014d470;
  cmplwi r28, 2;
  bne lbl_8014d4f4;
lbl_8014d470:
  mr r3, r26;
  bl btm_sec_is_bonding;
  clrlwi. r0, r3, 0x18;
  bne lbl_8014d4f4;
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014d4b8;
  addi r3, r3, -27840;
  lis r4, 8;
  lhz r9, 0x7c8(r3);
  addi r3, r4, 1;
  lhz r6, 6(r27);
  mr r5, r26;
  mr r7, r24;
  mr r8, r28;
  addi r4, r30, 0x24;
  bl LogMsg_5;
lbl_8014d4b8:
  li r0, 2;
  lis r28, 0x8034;
  addi r28, r28, -27840;
  sth r0, 6(r27);
  mr r4, r27;
  addi r3, r28, 0x7c0;
  bl GKI_enqueue;
  lhz r0, 0x7c8(r28);
  cmplwi r0, 1;
  bne lbl_8014d6c0;
  addi r3, r28, 0x7cc;
  li r4, 4;
  li r5, 1;
  bl btu_start_timer;
  b lbl_8014d6c0;
lbl_8014d4f4:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d500:
  lhz r4, 4(r27);
  lbz r5, 0xb(r31);
  addi r0, r4, 4;
  lbz r6, 0xa(r31);
  slwi r4, r5, 8;
  sth r0, 4(r27);
  add r0, r6, r4;
  clrlwi r25, r0, 0x10;
  lbz r0, 0xf(r31);
  lbz r4, 0xe(r31);
  slwi r0, r0, 8;
  lbz r5, 0xd(r31);
  add r0, r4, r0;
  lbz r4, 0xc(r31);
  clrlwi r26, r0, 0x10;
  slwi r0, r5, 8;
  add r0, r4, r0;
  cmplwi r26, 2;
  clrlwi r24, r0, 0x10;
  ble lbl_8014d594;
  mr r4, r26;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  mr r28, r3;
  bne lbl_8014d594;
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014d588;
  lis r3, 8;
  mr r5, r26;
  addi r3, r3, 1;
  addi r4, r30, 0x78;
  bl LogMsg_1;
lbl_8014d588:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d594:
  cmplwi r25, 4;
  blt lbl_8014d5b4;
  lhz r3, 4(r27);
  addi r4, r25, -4;
  sth r4, 2(r27);
  addi r0, r3, 4;
  sth r0, 4(r27);
  b lbl_8014d5e0;
lbl_8014d5b4:
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014d5d4;
  lis r3, 8;
  addi r4, r30, 0x90;
  addi r3, r3, 1;
  bl LogMsg_0;
lbl_8014d5d4:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d5e0:
  clrlwi r6, r4, 0x10;
  cmplw r24, r6;
  beq lbl_8014d61c;
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014d610;
  lis r3, 8;
  mr r5, r24;
  addi r4, r30, 0xb4;
  addi r3, r3, 1;
  bl LogMsg_2;
lbl_8014d610:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d61c:
  cmplwi r26, 1;
  bne lbl_8014d640;
  mr r3, r29;
  mr r5, r24;
  addi r4, r31, 0x10;
  bl process_l2cap_cmd;
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d640:
  cmplwi r26, 2;
  bne lbl_8014d69c;
  clrlwi r3, r0, 0x10;
  lbz r4, 0x11(r31);
  lbz r5, 0x10(r31);
  addi r3, r3, 2;
  addi r0, r6, -2;
  slwi r4, r4, 8;
  sth r3, 4(r27);
  lis r3, 0x8034;
  add r4, r5, r4;
  sth r0, 2(r27);
  clrlwi r5, r4, 0x10;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 5;
  blt lbl_8014d690;
  lis r3, 8;
  addi r4, r30, 0xe0;
  addi r3, r3, 4;
  bl LogMsg_1;
lbl_8014d690:
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d69c:
  cmpwi r28, 0;
  bne lbl_8014d6b0;
  mr r3, r27;
  bl GKI_freebuf;
  b lbl_8014d6c0;
lbl_8014d6b0:
  mr r3, r28;
  mr r5, r27;
  li r4, 0x13;
  bl l2c_csm_execute;
lbl_8014d6c0:
  addi r11, r1, 0x30;
  bl _restgpr_24;
  lwz r0, 0x34(r1);
  mtlr r0;
  addi r1, r1, 0x30;
  blr;
  // clang-format on
}

// Symbol: process_l2cap_cmd
// PAL: 0x8014d6d8..0x8014e148
MARK_BINARY_BLOB(process_l2cap_cmd, 0x8014d6d8, 0x8014e148);
asm UNKNOWN_FUNCTION(process_l2cap_cmd) {
  // clang-format off
  nofralloc;
  stwu r1, -0xa0(r1);
  mflr r0;
  stw r0, 0xa4(r1);
  addi r11, r1, 0xa0;
  bl _savegpr_14;
  add r22, r4, r5;
  lis r23, 0x8028;
  lis r30, 0x8033;
  mr r21, r4;
  li r31, 0;
  mr r15, r3;
  mr r14, r5;
  addi r23, r23, 0x66d8;
  addi r30, r30, 0x5d50;
  addi r24, r22, -4;
  li r28, 1;
  lis r29, 8;
  lis r27, 0x8034;
  lis r26, 0x8028;
lbl_8014d724:
  cmplw r21, r24;
  mr r16, r21;
  bgt lbl_8014e130;
  lbz r0, 3(r21);
  lbz r3, 2(r21);
  slwi r0, r0, 8;
  lbz r7, 0(r21);
  add r0, r3, r0;
  lbz r25, 1(r21);
  clrlwi r17, r0, 0x10;
  add r3, r21, r17;
  addi r21, r3, 4;
  cmplw r21, r22;
  ble lbl_8014d788;
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014e130;
  lis r3, 8;
  mr r5, r14;
  mr r6, r17;
  addi r4, r23, 0x100;
  addi r3, r3, 1;
  bl LogMsg_3;
  b lbl_8014e130;
lbl_8014d788:
  cmplwi r7, 0xb;
  bgt lbl_8014e0f4;
  addi r3, r26, 0x697c;
  slwi r0, r7, 2;
  lwzx r3, r3, r0;
  mtctr r3;
  bctr;
  lbz r0, 5(r16);
  lbz r3, 4(r16);
  addi r16, r16, 6;
  slwi r0, r0, 8;
  add r0, r3, r0;
  clrlwi r17, r0, 0x10;
  cmplwi r17, 1;
  bne lbl_8014d7f8;
  lbz r3, 1(r16);
  lbz r0, -0x6cc0(r27);
  lbz r4, 0(r16);
  slwi r3, r3, 8;
  cmplwi r0, 2;
  addi r16, r16, 2;
  add r0, r4, r3;
  clrlwi r6, r0, 0x10;
  blt lbl_8014d7f8;
  lhz r5, 0x28(r15);
  addi r3, r29, 1;
  addi r4, r23, 0x134;
  bl LogMsg_2;
lbl_8014d7f8:
  cmplwi r17, 2;
  bne lbl_8014d724;
  lbz r4, 1(r16);
  lbz r3, 3(r16);
  lbz r0, -0x6cc0(r27);
  slwi r5, r4, 8;
  lbz r6, 0(r16);
  slwi r3, r3, 8;
  lbz r4, 2(r16);
  cmplwi r0, 2;
  add r5, r6, r5;
  add r0, r4, r3;
  clrlwi r17, r5, 0x10;
  clrlwi r16, r0, 0x10;
  blt lbl_8014d848;
  mr r5, r16;
  mr r6, r17;
  addi r3, r29, 1;
  addi r4, r23, 0x158;
  bl LogMsg_2;
lbl_8014d848:
  mr r3, r15;
  mr r4, r16;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  beq lbl_8014d724;
  lhz r0, 0x16(r3);
  cmplw r0, r17;
  bne lbl_8014d724;
  li r4, 3;
  li r5, 0;
  bl l2c_csm_execute;
  b lbl_8014d724;
  lbz r0, 5(r16);
  lbz r3, 4(r16);
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x10(r1);
  clrlwi r3, r0, 0x10;
  lbz r0, 7(r16);
  lbz r4, 6(r16);
  slwi r0, r0, 8;
  add r0, r4, r0;
  clrlwi r17, r0, 0x10;
  bl l2cu_find_rcb_by_psm;
  cmpwi r3, 0;
  mr r16, r3;
  bne lbl_8014d8e8;
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 2;
  blt lbl_8014d8d0;
  lhz r5, 0x10(r1);
  addi r3, r29, 1;
  addi r4, r23, 0x188;
  bl LogMsg_1;
lbl_8014d8d0:
  mr r3, r15;
  mr r4, r17;
  mr r5, r25;
  li r6, 2;
  bl l2cu_reject_connection;
  b lbl_8014d724;
lbl_8014d8e8:
  mr r3, r15;
  bl l2cu_allocate_ccb;
  cmpwi r3, 0;
  bne lbl_8014d928;
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 1;
  blt lbl_8014d910;
  addi r4, r23, 0x1b4;
  lis r3, 8;
  bl LogMsg_0;
lbl_8014d910:
  mr r3, r15;
  mr r4, r17;
  mr r5, r25;
  li r6, 4;
  bl l2cu_reject_connection;
  b lbl_8014d724;
lbl_8014d928:
  stb r25, 0x36(r3);
  addi r5, r1, 8;
  li r4, 0xa;
  stw r16, 0x30(r3);
  sth r17, 0x16(r3);
  bl l2c_csm_execute;
  b lbl_8014d724;
  lbz r0, 5(r16);
  mr r3, r15;
  lbz r4, 4(r16);
  slwi r0, r0, 8;
  add r0, r4, r0;
  sth r0, 0x16(r1);
  lbz r0, 9(r16);
  lbz r4, 8(r16);
  slwi r0, r0, 8;
  lbz r5, 7(r16);
  add r0, r4, r0;
  lbz r6, 6(r16);
  slwi r4, r5, 8;
  sth r0, 0x12(r1);
  add r0, r6, r4;
  clrlwi r17, r0, 0x10;
  lbz r0, 0xb(r16);
  mr r4, r17;
  lbz r5, 0xa(r16);
  slwi r0, r0, 8;
  add r0, r5, r0;
  sth r0, 0x14(r1);
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  bne lbl_8014d9cc;
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 2;
  blt lbl_8014d724;
  lhz r6, 0x16(r1);
  mr r5, r17;
  addi r3, r29, 1;
  addi r4, r23, 0x1d4;
  bl LogMsg_2;
  b lbl_8014d724;
lbl_8014d9cc:
  lbz r5, 0x35(r3);
  cmplw r5, r25;
  beq lbl_8014d9f8;
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 2;
  blt lbl_8014d724;
  mr r6, r25;
  addi r3, r29, 1;
  addi r4, r23, 0x204;
  bl LogMsg_2;
  b lbl_8014d724;
lbl_8014d9f8:
  lhz r0, 0x12(r1);
  cmpwi r0, 0;
  bne lbl_8014da14;
  addi r5, r1, 8;
  li r4, 0xb;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014da14:
  cmplwi r0, 1;
  bne lbl_8014da2c;
  addi r5, r1, 8;
  li r4, 0xc;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014da2c:
  addi r5, r1, 8;
  li r4, 0xd;
  bl l2c_csm_execute;
  b lbl_8014d724;
  lbz r0, 7(r16);
  li r19, 0;
  lbz r4, 5(r16);
  li r18, 0;
  lbz r3, 6(r16);
  slwi r0, r0, 8;
  lbz r5, 4(r16);
  slwi r4, r4, 8;
  add r0, r3, r0;
  addi r16, r16, 8;
  add r3, r5, r4;
  sth r0, 0x50(r1);
  mr r20, r16;
  stb r19, 0x3c(r1);
  clrlwi r4, r3, 0x10;
  stb r19, 0x1e(r1);
  stb r19, 0x1a(r1);
  stb r19, 0x38(r1);
  b lbl_8014dc84;
lbl_8014da88:
  lbz r5, 0(r16);
  lbz r3, 1(r16);
  addi r16, r16, 2;
  clrlwi r0, r5, 0x19;
  cmpwi r0, 3;
  beq lbl_8014db00;
  bge lbl_8014dab4;
  cmpwi r0, 1;
  beq lbl_8014dac0;
  bge lbl_8014dae0;
  b lbl_8014dc58;
lbl_8014dab4:
  cmpwi r0, 5;
  bge lbl_8014dc58;
  b lbl_8014dbf8;
lbl_8014dac0:
  stb r28, 0x1a(r1);
  lbz r0, 1(r16);
  lbz r3, 0(r16);
  addi r16, r16, 2;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x1c(r1);
  b lbl_8014dc84;
lbl_8014dae0:
  stb r28, 0x38(r1);
  lbz r0, 1(r16);
  lbz r3, 0(r16);
  addi r16, r16, 2;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x3a(r1);
  b lbl_8014dc84;
lbl_8014db00:
  stb r28, 0x1e(r1);
  lbz r0, 0(r16);
  stb r0, 0x20(r1);
  lbz r0, 1(r16);
  stb r0, 0x21(r1);
  lbz r3, 5(r16);
  lbz r5, 4(r16);
  lbz r0, 3(r16);
  slwi r6, r3, 0x18;
  lbz r3, 2(r16);
  slwi r5, r5, 0x10;
  slwi r0, r0, 8;
  add r3, r5, r3;
  add r0, r6, r0;
  add r0, r3, r0;
  stw r0, 0x24(r1);
  lbz r3, 9(r16);
  lbz r5, 8(r16);
  lbz r0, 7(r16);
  slwi r6, r3, 0x18;
  lbz r3, 6(r16);
  slwi r5, r5, 0x10;
  slwi r0, r0, 8;
  add r3, r5, r3;
  add r0, r6, r0;
  add r0, r3, r0;
  stw r0, 0x28(r1);
  lbz r3, 0xd(r16);
  lbz r5, 0xc(r16);
  lbz r0, 0xb(r16);
  slwi r6, r3, 0x18;
  lbz r3, 0xa(r16);
  slwi r5, r5, 0x10;
  slwi r0, r0, 8;
  add r3, r5, r3;
  add r0, r6, r0;
  add r0, r3, r0;
  stw r0, 0x2c(r1);
  lbz r3, 0x11(r16);
  lbz r5, 0x10(r16);
  lbz r0, 0xf(r16);
  slwi r6, r3, 0x18;
  lbz r3, 0xe(r16);
  slwi r5, r5, 0x10;
  slwi r0, r0, 8;
  add r3, r5, r3;
  add r0, r6, r0;
  add r0, r3, r0;
  stw r0, 0x30(r1);
  lbz r3, 0x15(r16);
  lbz r5, 0x14(r16);
  lbz r0, 0x13(r16);
  slwi r6, r3, 0x18;
  lbz r3, 0x12(r16);
  slwi r5, r5, 0x10;
  slwi r0, r0, 8;
  addi r16, r16, 0x16;
  add r3, r5, r3;
  add r0, r6, r0;
  add r0, r3, r0;
  stw r0, 0x34(r1);
  b lbl_8014dc84;
lbl_8014dbf8:
  stb r28, 0x3c(r1);
  lbz r0, 0(r16);
  stb r0, 0x3e(r1);
  lbz r0, 1(r16);
  stb r0, 0x3f(r1);
  lbz r0, 2(r16);
  stb r0, 0x40(r1);
  lbz r0, 4(r16);
  lbz r3, 3(r16);
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x42(r1);
  lbz r0, 6(r16);
  lbz r3, 5(r16);
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x44(r1);
  lbz r0, 8(r16);
  lbz r3, 7(r16);
  addi r16, r16, 9;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x46(r1);
  b lbl_8014dc84;
lbl_8014dc58:
  addi r6, r3, 2;
  cmpw r6, r17;
  bgt lbl_8014dc80;
  rlwinm. r0, r5, 0, 0x18, 0x18;
  add r16, r16, r3;
  bne lbl_8014dc84;
  add r0, r18, r6;
  li r19, 1;
  clrlwi r18, r0, 0x10;
  b lbl_8014dc84;
lbl_8014dc80:
  mr r16, r21;
lbl_8014dc84:
  cmplw r16, r21;
  blt lbl_8014da88;
  mr r3, r15;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  beq lbl_8014dcd0;
  cmpwi r19, 0;
  stb r25, 0x36(r3);
  beq lbl_8014dcc0;
  addi r0, r17, -4;
  mr r4, r20;
  mr r6, r18;
  clrlwi r5, r0, 0x10;
  bl l2cu_send_peer_config_rej;
  b lbl_8014d724;
lbl_8014dcc0:
  addi r5, r1, 0x18;
  li r4, 0xe;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014dcd0:
  mr r3, r15;
  mr r5, r25;
  li r4, 2;
  li r6, 0;
  li r7, 0;
  bl l2cu_send_peer_cmd_reject;
  b lbl_8014d724;
  lbz r0, 7(r16);
  lbz r3, 6(r16);
  slwi r0, r0, 8;
  lbz r4, 5(r16);
  add r0, r3, r0;
  lbz r5, 4(r16);
  slwi r3, r4, 8;
  sth r0, 0x50(r1);
  add r0, r5, r3;
  clrlwi r17, r0, 0x10;
  lbz r0, 9(r16);
  lbz r3, 8(r16);
  addi r16, r16, 0xa;
  slwi r0, r0, 8;
  add r0, r3, r0;
  stb r31, 0x1e(r1);
  sth r0, 0x18(r1);
  stb r31, 0x1a(r1);
  stb r31, 0x38(r1);
  stb r31, 0x3c(r1);
  b lbl_8014df08;
lbl_8014dd40:
  lbz r0, 0(r16);
  addi r16, r16, 2;
  clrlwi r0, r0, 0x19;
  cmpwi r0, 3;
  beq lbl_8014ddb4;
  bge lbl_8014dd68;
  cmpwi r0, 1;
  beq lbl_8014dd74;
  bge lbl_8014dd94;
  b lbl_8014df08;
lbl_8014dd68:
  cmpwi r0, 5;
  bge lbl_8014df08;
  b lbl_8014deac;
lbl_8014dd74:
  stb r28, 0x1a(r1);
  lbz r0, 1(r16);
  lbz r3, 0(r16);
  addi r16, r16, 2;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x1c(r1);
  b lbl_8014df08;
lbl_8014dd94:
  stb r28, 0x38(r1);
  lbz r0, 1(r16);
  lbz r3, 0(r16);
  addi r16, r16, 2;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x3a(r1);
  b lbl_8014df08;
lbl_8014ddb4:
  stb r28, 0x1e(r1);
  lbz r0, 0(r16);
  stb r0, 0x20(r1);
  lbz r0, 1(r16);
  stb r0, 0x21(r1);
  lbz r3, 5(r16);
  lbz r4, 4(r16);
  lbz r0, 3(r16);
  slwi r5, r3, 0x18;
  lbz r3, 2(r16);
  slwi r4, r4, 0x10;
  slwi r0, r0, 8;
  add r3, r4, r3;
  add r0, r5, r0;
  add r0, r3, r0;
  stw r0, 0x24(r1);
  lbz r3, 9(r16);
  lbz r4, 8(r16);
  lbz r0, 7(r16);
  slwi r5, r3, 0x18;
  lbz r3, 6(r16);
  slwi r4, r4, 0x10;
  slwi r0, r0, 8;
  add r3, r4, r3;
  add r0, r5, r0;
  add r0, r3, r0;
  stw r0, 0x28(r1);
  lbz r3, 0xd(r16);
  lbz r4, 0xc(r16);
  lbz r0, 0xb(r16);
  slwi r5, r3, 0x18;
  lbz r3, 0xa(r16);
  slwi r4, r4, 0x10;
  slwi r0, r0, 8;
  add r3, r4, r3;
  add r0, r5, r0;
  add r0, r3, r0;
  stw r0, 0x2c(r1);
  lbz r3, 0x11(r16);
  lbz r4, 0x10(r16);
  lbz r0, 0xf(r16);
  slwi r5, r3, 0x18;
  lbz r3, 0xe(r16);
  slwi r4, r4, 0x10;
  slwi r0, r0, 8;
  add r3, r4, r3;
  add r0, r5, r0;
  add r0, r3, r0;
  stw r0, 0x30(r1);
  lbz r3, 0x15(r16);
  lbz r4, 0x14(r16);
  lbz r0, 0x13(r16);
  slwi r5, r3, 0x18;
  lbz r3, 0x12(r16);
  slwi r4, r4, 0x10;
  slwi r0, r0, 8;
  addi r16, r16, 0x16;
  add r3, r4, r3;
  add r0, r5, r0;
  add r0, r3, r0;
  stw r0, 0x34(r1);
  b lbl_8014df08;
lbl_8014deac:
  stb r28, 0x3c(r1);
  lbz r0, 0(r16);
  stb r0, 0x3e(r1);
  lbz r0, 1(r16);
  stb r0, 0x3f(r1);
  lbz r0, 2(r16);
  stb r0, 0x40(r1);
  lbz r0, 4(r16);
  lbz r3, 3(r16);
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x42(r1);
  lbz r0, 6(r16);
  lbz r3, 5(r16);
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x44(r1);
  lbz r0, 8(r16);
  lbz r3, 7(r16);
  addi r16, r16, 9;
  slwi r0, r0, 8;
  add r0, r3, r0;
  sth r0, 0x46(r1);
lbl_8014df08:
  cmplw r16, r21;
  blt lbl_8014dd40;
  mr r3, r15;
  mr r4, r17;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  beq lbl_8014df7c;
  lbz r5, 0x35(r3);
  cmplw r5, r25;
  beq lbl_8014df50;
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 2;
  blt lbl_8014d724;
  mr r6, r25;
  addi r3, r29, 1;
  addi r4, r23, 0x230;
  bl LogMsg_2;
  b lbl_8014d724;
lbl_8014df50:
  lhz r0, 0x18(r1);
  cmpwi r0, 0;
  bne lbl_8014df6c;
  addi r5, r1, 0x18;
  li r4, 0xf;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014df6c:
  addi r5, r1, 0x18;
  li r4, 0x10;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014df7c:
  lbz r0, -0x6cc0(r27);
  cmplwi r0, 2;
  blt lbl_8014d724;
  mr r5, r17;
  addi r3, r29, 1;
  addi r4, r23, 0x25c;
  bl LogMsg_1;
  b lbl_8014d724;
  lbz r4, 5(r16);
  mr r3, r15;
  lbz r0, 7(r16);
  slwi r5, r4, 8;
  lbz r6, 4(r16);
  lbz r4, 6(r16);
  slwi r0, r0, 8;
  add r5, r6, r5;
  add r0, r4, r0;
  clrlwi r16, r5, 0x10;
  mr r4, r16;
  clrlwi r17, r0, 0x10;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  beq lbl_8014dff8;
  lhz r0, 0x16(r3);
  cmplw r0, r17;
  bne lbl_8014d724;
  stb r25, 0x36(r3);
  addi r5, r1, 8;
  li r4, 0x11;
  bl l2c_csm_execute;
  b lbl_8014d724;
lbl_8014dff8:
  mr r3, r15;
  mr r4, r25;
  mr r5, r16;
  mr r6, r17;
  bl l2cu_send_peer_disc_rsp;
  b lbl_8014d724;
  lbz r4, 5(r16);
  mr r3, r15;
  lbz r0, 7(r16);
  slwi r5, r4, 8;
  lbz r6, 4(r16);
  lbz r4, 6(r16);
  slwi r0, r0, 8;
  add r5, r6, r5;
  add r0, r4, r0;
  clrlwi r16, r5, 0x10;
  clrlwi r4, r0, 0x10;
  bl l2cu_find_ccb_by_cid;
  cmpwi r3, 0;
  beq lbl_8014d724;
  lhz r0, 0x16(r3);
  cmplw r0, r16;
  bne lbl_8014d724;
  lbz r0, 0x35(r3);
  cmplw r0, r25;
  bne lbl_8014d724;
  addi r5, r1, 8;
  li r4, 0x12;
  bl l2c_csm_execute;
  b lbl_8014d724;
  lhz r3, 0x7e(r30);
  addi r0, r3, -12;
  cmpw r17, r0;
  bge lbl_8014e098;
  mr r3, r15;
  mr r4, r25;
  mr r6, r17;
  addi r5, r16, 4;
  bl l2cu_send_peer_echo_rsp;
  b lbl_8014d724;
lbl_8014e098:
  mr r3, r15;
  mr r4, r25;
  li r5, 0;
  li r6, 0;
  bl l2cu_send_peer_echo_rsp;
  b lbl_8014d724;
  lwz r12, 0x54(r15);
  cmpwi r12, 0;
  beq lbl_8014d724;
  stw r31, 0x54(r15);
  li r3, 0;
  mtctr r12;
  bctrl;
  b lbl_8014d724;
  lbz r0, 5(r16);
  mr r3, r15;
  lbz r5, 4(r16);
  mr r4, r25;
  slwi r0, r0, 8;
  add r0, r5, r0;
  clrlwi r5, r0, 0x10;
  bl l2cu_send_peer_info_rsp;
  b lbl_8014d724;
lbl_8014e0f4:
  lis r3, 0x8034;
  lbz r0, -0x6cc0(r3);
  cmplwi r0, 2;
  blt lbl_8014e118;
  lis r3, 8;
  mr r5, r7;
  addi r3, r3, 1;
  addi r4, r23, 0x288;
  bl LogMsg_1;
lbl_8014e118:
  mr r3, r15;
  mr r5, r25;
  li r4, 0;
  li r6, 0;
  li r7, 0;
  bl l2cu_send_peer_cmd_reject;
lbl_8014e130:
  addi r11, r1, 0xa0;
  bl _restgpr_14;
  lwz r0, 0xa4(r1);
  mtlr r0;
  addi r1, r1, 0xa0;
  blr;
  // clang-format on
}

// Symbol: l2c_process_timeout
// PAL: 0x8014e148..0x8014e198
MARK_BINARY_BLOB(l2c_process_timeout, 0x8014e148, 0x8014e198);
asm UNKNOWN_FUNCTION(l2c_process_timeout) {
  // clang-format off
  nofralloc;
  lhz r0, 0x14(r3);
  cmpwi r0, 4;
  beq lbl_8014e18c;
  bge lbl_8014e168;
  cmpwi r0, 2;
  beq lbl_8014e174;
  bge lbl_8014e17c;
  blr;
lbl_8014e168:
  cmpwi r0, 0x49;
  beqlr;
  blr;
lbl_8014e174:
  lwz r3, 0x10(r3);
  b l2c_link_timeout;
lbl_8014e17c:
  lwz r3, 0x10(r3);
  li r4, 0x1e;
  li r5, 0;
  b l2c_csm_execute;
lbl_8014e18c:
  li r3, 1;
  b l2c_process_held_packets;
  blr;
  // clang-format on
}

// Symbol: l2c_process_held_packets
// PAL: 0x8014e198..0x8014e2c4
MARK_BINARY_BLOB(l2c_process_held_packets, 0x8014e198, 0x8014e2c4);
asm UNKNOWN_FUNCTION(l2c_process_held_packets) {
  // clang-format off
  nofralloc;
  stwu r1, -0x20(r1);
  mflr r0;
  stw r0, 0x24(r1);
  addi r11, r1, 0x20;
  bl _savegpr_27;
  lis r31, 0x8034;
  mr r27, r3;
  addi r4, r31, -27840;
  lhz r0, 0x7c8(r4);
  addi r28, r4, 0x7c0;
  cmpwi r0, 0;
  beq lbl_8014e2ac;
  cmpwi r3, 0;
  bne lbl_8014e1fc;
  addi r3, r4, 0x7cc;
  bl btu_stop_timer;
  lbz r0, -0x6cc0(r31);
  cmplwi r0, 2;
  blt lbl_8014e21c;
  lis r3, 8;
  lis r4, 0x8028;
  addi r3, r3, 1;
  addi r4, r4, 0x69ac;
  bl LogMsg_0;
  b lbl_8014e21c;
lbl_8014e1fc:
  lbz r0, -0x6cc0(r31);
  cmplwi r0, 2;
  blt lbl_8014e21c;
  lis r3, 8;
  lis r4, 0x8028;
  addi r3, r3, 1;
  addi r4, r4, 0x69c0;
  bl LogMsg_0;
lbl_8014e21c:
  mr r3, r28;
  bl GKI_getfirst;
  lis r4, 1;
  mr r30, r3;
  addi r31, r4, -1;
  b lbl_8014e280;
lbl_8014e234:
  mr r3, r30;
  bl GKI_getnext;
  cmpwi r27, 0;
  mr r29, r3;
  beq lbl_8014e264;
  lhz r3, 6(r30);
  cmpwi r3, 0;
  beq lbl_8014e264;
  addi r3, r3, -1;
  clrlwi. r0, r3, 0x10;
  sth r3, 6(r30);
  bne lbl_8014e27c;
lbl_8014e264:
  mr r3, r28;
  mr r4, r30;
  bl GKI_remove_from_queue;
  sth r31, 6(r30);
  mr r3, r30;
  bl l2c_rcv_acl_data;
lbl_8014e27c:
  mr r30, r29;
lbl_8014e280:
  cmpwi r30, 0;
  bne lbl_8014e234;
  lhz r0, 8(r28);
  cmpwi r0, 0;
  beq lbl_8014e2ac;
  lis r3, 0x8034;
  li r4, 4;
  addi r3, r3, -27840;
  li r5, 1;
  addi r3, r3, 0x7cc;
  bl btu_start_timer;
lbl_8014e2ac:
  addi r11, r1, 0x20;
  bl _restgpr_27;
  lwz r0, 0x24(r1);
  mtlr r0;
  addi r1, r1, 0x20;
  blr;
  // clang-format on
}
