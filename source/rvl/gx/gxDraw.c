#include "gxDraw.h"

#include <math.h>

#include "gxAttr.h"
#include "gxGeometry.h"

extern const f32 unk_803887c8;
extern const f32 unk_803887cc;
extern const f64 unk_803887d0;
extern const f32 unk_803887d8;
extern const f32 unk_803887dc;
extern const f32 unk_803887e0;

// Symbol: GXDrawSphere
// PAL: 0x80172a30..0x80172e00
MARK_BINARY_BLOB(GXDrawSphere, 0x80172a30, 0x80172e00);
asm UNKNOWN_FUNCTION(GXDrawSphere) {
  // clang-format off
  nofralloc;
  stwu r1, -0x110(r1);
  mflr r0;
  stw r0, 0x114(r1);
  stfd f31, 0x100(r1);
  psq_st f31, 264(r1), 0, 0;
  stfd f30, 0xf0(r1);
  psq_st f30, 248(r1), 0, 0;
  stfd f29, 0xe0(r1);
  psq_st f29, 232(r1), 0, 0;
  stfd f28, 0xd0(r1);
  psq_st f28, 216(r1), 0, 0;
  stfd f27, 0xc0(r1);
  psq_st f27, 200(r1), 0, 0;
  stfd f26, 0xb0(r1);
  psq_st f26, 184(r1), 0, 0;
  stfd f25, 0xa0(r1);
  psq_st f25, 168(r1), 0, 0;
  stfd f24, 0x90(r1);
  psq_st f24, 152(r1), 0, 0;
  stfd f23, 0x80(r1);
  psq_st f23, 136(r1), 0, 0;
  stfd f22, 0x70(r1);
  psq_st f22, 120(r1), 0, 0;
  stfd f21, 0x60(r1);
  psq_st f21, 104(r1), 0, 0;
  stfd f20, 0x50(r1);
  psq_st f20, 88(r1), 0, 0;
  stfd f19, 0x40(r1);
  psq_st f19, 72(r1), 0, 0;
  addi r11, r1, 0x40;
  bl _savegpr_25;
  lis r0, 0x4330;
  stw r3, 0x14(r1);
  mr r25, r3;
  lfd f4, unk_803887d8;
  stw r0, 0x10(r1);
  mr r26, r4;
  lfs f2, unk_803887cc;
  li r3, 0xd;
  stw r4, 0x1c(r1);
  addi r4, r1, 8;
  lfd f0, 0x10(r1);
  stw r0, 0x18(r1);
  fsubs f3, f0, f4;
  lfs f0, unk_803887e0;
  lfd f1, 0x18(r1);
  lfs f26, unk_803887c8;
  fsubs f1, f1, f4;
  fdivs f25, f2, f3;
  fdivs f24, f0, f1;
  bl GXGetVtxDesc;
  lis r3, 0x8034;
  addi r3, r3, 0x3e08;
  bl GXGetVtxDescv;
  lis r4, 0x8034;
  li r3, 3;
  addi r4, r4, 0x3ee0;
  bl GXGetVtxAttrFmtv;
  bl GXClearVtxDesc;
  li r3, 9;
  li r4, 1;
  bl GXSetVtxDesc;
  li r3, 0xa;
  li r4, 1;
  bl GXSetVtxDesc;
  li r3, 3;
  li r4, 9;
  li r5, 1;
  li r6, 4;
  li r7, 0;
  bl GXSetVtxAttrFmt;
  li r3, 3;
  li r4, 0xa;
  li r5, 0;
  li r6, 4;
  li r7, 0;
  bl GXSetVtxAttrFmt;
  lwz r0, 8(r1);
  cmpwi r0, 0;
  beq lbl_80172b94;
  li r3, 0xd;
  li r4, 1;
  bl GXSetVtxDesc;
  li r3, 3;
  li r4, 0xd;
  li r5, 1;
  li r6, 4;
  li r7, 0;
  bl GXSetVtxAttrFmt;
lbl_80172b94:
  addi r0, r26, 1;
  lfd f28, unk_803887d0;
  lfd f30, unk_803887d8;
  slwi r30, r0, 1;
  li r28, 0;
  lis r31, 0xcc01;
  b lbl_80172d5c;
lbl_80172bb0:
  xoris r0, r28, 0x8000;
  stw r0, 0x14(r1);
  lfd f0, 0x10(r1);
  fsubs f0, f0, f28;
  fmuls f20, f0, f25;
  fmr f1, f20;
  fadds f21, f20, f25;
  bl sin;
  frsp f0, f1;
  fmr f1, f21;
  fmuls f23, f26, f0;
  bl sin;
  frsp f0, f1;
  fmr f1, f20;
  fmuls f22, f26, f0;
  bl cos;
  frsp f0, f1;
  fmr f1, f21;
  fmuls f21, f26, f0;
  bl cos;
  frsp f0, f1;
  clrlwi r5, r30, 0x10;
  li r3, 0x98;
  li r4, 3;
  fmuls f20, f26, f0;
  bl GXBegin;
  fdivs f29, f20, f26;
  lwz r29, 8(r1);
  li r27, 0;
  fdivs f31, f21, f26;
  b lbl_80172d50;
lbl_80172c2c:
  xoris r0, r27, 0x8000;
  stw r0, 0x1c(r1);
  lfd f0, 0x18(r1);
  fsubs f0, f0, f28;
  fmuls f19, f0, f24;
  fmr f1, f19;
  bl cos;
  frsp f27, f1;
  fmr f1, f19;
  bl sin;
  frsp f4, f1;
  cmpwi r29, 0;
  fmuls f2, f27, f22;
  fmuls f0, f4, f22;
  stfs f2, -0x8000(r31);
  fdivs f1, f2, f26;
  stfs f0, -0x8000(r31);
  stfs f20, -0x8000(r31);
  fdivs f0, f0, f26;
  stfs f1, -0x8000(r31);
  stfs f0, -0x8000(r31);
  stfs f29, -0x8000(r31);
  beq lbl_80172cd4;
  xoris r3, r27, 0x8000;
  stw r26, 0x1c(r1);
  addi r0, r28, 1;
  stw r3, 0x14(r1);
  xoris r0, r0, 0x8000;
  lfd f0, 0x18(r1);
  lfd f1, 0x10(r1);
  stw r25, 0x1c(r1);
  fsubs f2, f0, f30;
  fsubs f3, f1, f28;
  stw r0, 0x14(r1);
  lfd f0, 0x18(r1);
  lfd f1, 0x10(r1);
  fdivs f2, f3, f2;
  fsubs f1, f1, f28;
  stfs f2, -0x8000(r31);
  fsubs f0, f0, f30;
  fdivs f0, f1, f0;
  stfs f0, -0x8000(r31);
lbl_80172cd4:
  fmuls f2, f27, f23;
  cmpwi r29, 0;
  fmuls f0, f4, f23;
  stfs f2, -0x8000(r31);
  fdivs f1, f2, f26;
  stfs f0, -0x8000(r31);
  stfs f21, -0x8000(r31);
  fdivs f0, f0, f26;
  stfs f1, -0x8000(r31);
  stfs f0, -0x8000(r31);
  stfs f31, -0x8000(r31);
  beq lbl_80172d4c;
  xoris r3, r27, 0x8000;
  stw r26, 0x1c(r1);
  xoris r0, r28, 0x8000;
  stw r3, 0x14(r1);
  lfd f0, 0x18(r1);
  lfd f1, 0x10(r1);
  stw r25, 0x1c(r1);
  fsubs f2, f0, f30;
  fsubs f3, f1, f28;
  stw r0, 0x14(r1);
  lfd f0, 0x18(r1);
  lfd f1, 0x10(r1);
  fdivs f2, f3, f2;
  fsubs f1, f1, f28;
  stfs f2, -0x8000(r31);
  fsubs f0, f0, f30;
  fdivs f0, f1, f0;
  stfs f0, -0x8000(r31);
lbl_80172d4c:
  addi r27, r27, 1;
lbl_80172d50:
  cmpw r27, r26;
  ble lbl_80172c2c;
  addi r28, r28, 1;
lbl_80172d5c:
  cmpw r28, r25;
  blt lbl_80172bb0;
  lis r3, 0x8034;
  addi r3, r3, 0x3e08;
  bl GXSetVtxDescv;
  lis r4, 0x8034;
  li r3, 3;
  addi r4, r4, 0x3ee0;
  bl GXSetVtxAttrFmtv;
  psq_l f31, 264(r1), 0, 0;
  lfd f31, 0x100(r1);
  psq_l f30, 248(r1), 0, 0;
  lfd f30, 0xf0(r1);
  psq_l f29, 232(r1), 0, 0;
  lfd f29, 0xe0(r1);
  psq_l f28, 216(r1), 0, 0;
  lfd f28, 0xd0(r1);
  psq_l f27, 200(r1), 0, 0;
  lfd f27, 0xc0(r1);
  psq_l f26, 184(r1), 0, 0;
  lfd f26, 0xb0(r1);
  psq_l f25, 168(r1), 0, 0;
  lfd f25, 0xa0(r1);
  psq_l f24, 152(r1), 0, 0;
  lfd f24, 0x90(r1);
  psq_l f23, 136(r1), 0, 0;
  lfd f23, 0x80(r1);
  psq_l f22, 120(r1), 0, 0;
  lfd f22, 0x70(r1);
  psq_l f21, 104(r1), 0, 0;
  lfd f21, 0x60(r1);
  psq_l f20, 88(r1), 0, 0;
  lfd f20, 0x50(r1);
  psq_l f19, 72(r1), 0, 0;
  addi r11, r1, 0x40;
  lfd f19, 0x40(r1);
  bl _restgpr_25;
  lwz r0, 0x114(r1);
  mtlr r0;
  addi r1, r1, 0x110;
  blr;
  // clang-format on
}
